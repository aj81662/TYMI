<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Doctor Login</title>

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Glacial+Indifference&family=Hanken+Grotesk:wght@300;400&display=swap" rel="stylesheet"/>

<style>
:root {
  --deep-green: #29423B;
  --brick-red: #823A38;
  --coral: #DB6A6A;
  --mustard: #D7A346;
  --sky: #D6E3ED;
  --rose: #F8CED4;
  --font-primary: 'Glacial Indifference', sans-serif;
  --font-secondary: 'Hanken Grotesk', sans-serif;
}

body {
  font-family: var(--font-secondary);
  background: var(--sky);
  color: #222;
  margin: 0;
  padding: 0;
  display: flex;
  flex-direction: column;
  min-height: 100vh;
}

/* Header */
header {
  background-color: var(--deep-green);
  color: white;
  padding: 16px 10%;
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
}

header h1 {
  font-family: var(--font-primary);
  font-size: 1.6rem;
  margin: 0;
}

nav a {
  color: white;
  text-decoration: none;
  margin-left: 18px;
  font-weight: 500;
  transition: opacity 0.2s;
}

nav a:hover {
  opacity: 0.8;
  text-decoration: underline;
}

/* Login Box */
.container {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 40px 20px;
}

.box {
  background: #fff;
  padding: 32px;
  border-radius: 16px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.08);
  width: 340px;
  text-align: center;
}

.box h3 {
  font-family: var(--font-primary);
  color: var(--brick-red);
  margin-bottom: 20px;
}

input {
  width: 100%;
  padding: 10px;
  margin-top: 10px;
  border-radius: 8px;
  border: 1px solid #ccc;
  font-family: var(--font-secondary);
}

button {
  margin-top: 20px;
  padding: 12px;
  width: 100%;
  background: var(--deep-green);
  color: #fff;
  border: 0;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  font-family: var(--font-secondary);
  transition: background 0.3s;
}

button:hover {
  background: var(--brick-red);
}

#msg {
  color: var(--brick-red);
  margin-top: 12px;
  font-size: 0.9rem;
}

footer {
  text-align: center;
  padding: 16px;
  background: var(--rose);
  color: #333;
  font-size: 0.9rem;
}
</style>
</head>

<body>
  <header>
    <h1>Take Your Medicine Innovations</h1>
    <nav>
      <a href="./index.html">Home</a>
      <a href="./patient-login.html">Patient Portal</a>
      <a href="./change-password.html">Change Password</a>
      <a href="./create-account.html">Create Account</a>
    </nav>
  </header>

  <div class="container">
    <div class="box">
      <h3>Doctor Login</h3>
      <input id="username" placeholder="Username" />
      <input id="password" placeholder="Password" type="password" />
      <button id="login">Login</button>
      <div id="message"></div>
    </div>
  </div>

  <footer>
    Â© 2025 Take Your Medicine Innovations | Senior Capstone
  </footer>

<script>
/* Inlined _storage.js to avoid bundler 404/MIME issues when loaded inside WebView */
const STORAGE_KEY_PREFIX = 'TYMI_';
const isBrowser = typeof window !== 'undefined' && typeof document !== 'undefined';
const isReactNativeWebView = isBrowser && !!window.ReactNativeWebView;
const nativeStorageQueue = {};
function generateTransactionId(){return Math.random().toString(36).substring(2,15);} 
function resolveNativeStorageResponse(message){ if (message.type !== 'STORAGE_RESPONSE') return; const { txId, value, error } = message; const promiseHandlers = nativeStorageQueue[txId]; if (promiseHandlers){ delete nativeStorageQueue[txId]; if (error){ console.error(`WebView Storage Error (Tx:${txId}):`, error); promiseHandlers.reject(new Error(error)); } else { promiseHandlers.resolve(value); } } }
function sendNativeStorageRequest(action, key, value = null){ if (!isReactNativeWebView) { return Promise.reject(new Error("Attempted native storage outside WebView.")); } const txId = generateTransactionId(); return new Promise((resolve, reject) => { nativeStorageQueue[txId] = { resolve, reject }; try { console.log(`[WebView] Sending ${action} request for key: ${key}, TxID: ${txId}`); window.ReactNativeWebView.postMessage(JSON.stringify({ type: "STORAGE_OPERATION", action: action, key: key, value: value, txId: txId, })); } catch (e) { if (nativeStorageQueue[txId]) delete nativeStorageQueue[txId]; console.error("Failed to send native storage request:", e); reject(e); } }); }
async function getItem(key){ const fullKey = STORAGE_KEY_PREFIX + key; if (!isBrowser) return null; if (isReactNativeWebView){ return sendNativeStorageRequest('getItem', fullKey); } else { return Promise.resolve(localStorage.getItem(fullKey)); } }
async function setItem(key, value){ const fullKey = STORAGE_KEY_PREFIX + key; if (!isBrowser) return; if (isReactNativeWebView){ return sendNativeStorageRequest('setItem', fullKey, value); } else { localStorage.setItem(fullKey, value); return Promise.resolve(); } }
async function removeItem(key){ const fullKey = STORAGE_KEY_PREFIX + key; if (!isBrowser) return; if (isReactNativeWebView){ return sendNativeStorageRequest('removeItem', fullKey); } else { localStorage.removeItem(fullKey); return Promise.resolve(); } }
if (isBrowser){ window.Storage = { getItem: getItem, setItem: setItem, removeItem: removeItem, }; if (isReactNativeWebView){ window.addEventListener('message', (event) => { try { let data = event.data; if (typeof data === 'string') { data = JSON.parse(data); } if (data && data.type === 'STORAGE_RESPONSE') { resolveNativeStorageResponse(data); } } catch (e) { console.error("Error parsing native response in listener:", e); } }); } }
</script>

<script>
// --- CORE STORAGE HELPERS (Inlined from the first <script> block) ---
// The global window.Storage object is defined in the previous inlined <script> tag.
// We only need to define the simple data helpers here.

// Global variable to hold all users once loaded by initializeUsers
let ALL_USERS = []; 
const DEFAULT_DOCTOR_USERNAME = "doctor1";
const DEFAULT_DOCTOR_PASSWORD = "docpass";

async function loadUsers() {
    try {
        // Uses the window.Storage.getItem defined in the first script block
        const rawData = await window.Storage.getItem('users');
        const users = JSON.parse(rawData || '[]');
        return Array.isArray(users) ? users : [];
    } catch (e) {
        console.error("Error loading or parsing users:", e);
        return [];
    }
}

async function saveUsers(usersArray) {
    try {
        await window.Storage.setItem('users', JSON.stringify(usersArray));
    } catch (e) {
        console.error("Error saving users:", e);
    }
}

// --- AUTHENTICATION LOGIC ---

async function doLogin() {
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value.trim();
    
    // ðŸ”‘ FIX 1: Change 'message' to 'msg' to match the HTML ID
    const messageElement = document.getElementById('message'); 
    
    // Ensure the message element is present before trying to use it
    if (!messageElement) {
        console.error("CRITICAL UI ERROR: Login message element with ID 'msg' not found.");
        return;
    }

    messageElement.textContent = ''; // Clear previous message

    if (!username || !password) {
        messageElement.textContent = 'Please enter both username and password.';
        return;
    }

    // Use the global ALL_USERS loaded during initialization
    const users = ALL_USERS; 
    const user = users.find(u => u.username === username);

    if (user && user.password === password && user.role === 'doctor') {
        // SUCCESS: Save current user session and redirect
        const userSession = {
            username: user.username,
            role: user.role,
        };
        
        // Save the session data using the async Storage proxy
        await window.Storage.setItem('currentUser', JSON.stringify(userSession));
        await window.Storage.setItem('currentRole', user.role); // Save role separately for simplicity
        
        // Redirect to the dashboard
        window.location.href = 'doctor-dashboard.html';

    } else {
        // FAILURE
        messageElement.textContent = 'Invalid doctor credentials or role.';
        console.warn(`Login failed for user: ${username}`);
    }
}

// --- INITIALIZATION AND SEEDING ---

async function initializeUsers() {
    console.log("Starting user initialization...");
    let users = await loadUsers(); 

    const DEFAULT_USER = {
        username: DEFAULT_DOCTOR_USERNAME,
        password: DEFAULT_DOCTOR_PASSWORD,
        role: "doctor",
        approved: true,
    };
    
    let changed = false;
    const idx = users.findIndex(u => u.username === DEFAULT_USER.username && u.role === "doctor");
    
    if (idx === -1) {
        users.push(DEFAULT_USER);
        changed = true;
        console.log(`Default doctor '${DEFAULT_DOCTOR_USERNAME}' added.`);
    } else {
        // Minor check to ensure the existing default user has the doctor role
        if (users[idx].role !== 'doctor') {
            users[idx].role = 'doctor';
            changed = true;
            console.log(`Default user '${DEFAULT_DOCTOR_USERNAME}' role corrected to doctor.`);
        } else {
            console.log(`Default doctor '${DEFAULT_DOCTOR_USERNAME}' already present.`);
        }
    }

    if (changed) {
        await saveUsers(users); 
    }
    
    // CRITICAL FIX: Assign the loaded/seeded users to the global variable
    ALL_USERS = users; 
    console.log(`Initialization complete. Total users: ${ALL_USERS.length}.`);
    
    // Attach event listeners only after ASYNC initialization is complete
    const loginButton = document.getElementById("login");
    const passwordInput = document.getElementById("password");

    if (loginButton) {
        loginButton.addEventListener("click", doLogin);
    }
    
    // ASYNC keydown handler for "Enter" key on password field
    if (passwordInput) {
        passwordInput.addEventListener("keydown", async function(e){ 
            if (e.key === "Enter"){
                e.preventDefault(); 
                await doLogin();
            }
        });
    }
}

// --- START THE PROCESS ---
// ðŸ”‘ FIX 2: Ensure we wait for the DOMContentLoaded event before starting
// the ASYNC process to ensure input elements are available.
document.addEventListener("DOMContentLoaded", initializeUsers);

</script>
</body>
</html>