<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
 
<title>Patient Login</title>

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Glacial+Indifference&family=Hanken+Grotesk:wght@300;400&display=swap" rel="stylesheet"/>

<style>
/* ===== inlined: src/index.css (partial copy to match merged.html styles) ===== */
:root{--color-blue-600:#2563eb;--color-blue-500:#3b82f6;--color-gray-900:#111827;--color-gray-600:#4b5563;--color-gray-400:#9ca3af;--color-white:#fff;--radius:.625rem;--spacing:.25rem;--container-7xl:80rem}
html{font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif;}
body{margin:0;background:var(--color-white);color:var(--color-gray-900);-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
.max-w-7xl{max-width:var(--container-7xl);margin-inline:auto;padding-inline:1rem}
.px-4{padding-inline:1rem}.sm\:px-6{padding-inline:1.5rem}.lg\:px-8{padding-inline:2rem}
.py-16{padding-block:4rem}.py-20{padding-block:5rem}
.text-2xl{font-size:1.5rem}.text-3xl{font-size:1.875rem}.text-4xl{font-size:2.25rem}.text-5xl{font-size:3rem}
.font-bold{font-weight:700}.font-semibold{font-weight:600}
.text-gray-600{color:var(--color-gray-600)}.text-gray-400{color:var(--color-gray-400)}
.text-blue-600{color:var(--color-blue-600)}.bg-blue-600{background:var(--color-blue-600)}.bg-blue-500{background:var(--color-blue-500)}
.rounded-full{border-radius:9999px}.rounded-2xl{border-radius:1rem}
.bg-white{background:var(--color-white)}.border{border:1px solid #e5e7eb}
.shadow-sm{box-shadow:0 1px 2px rgba(0,0,0,.05)}.shadow-lg{box-shadow:0 10px 15px rgba(0,0,0,.08)}
.hidden{display:none}.md\:flex{display:flex}.md\:hidden{display:none}
.flex{display:flex}.items-center{align-items:center}.justify-between{justify-content:space-between}
.h-16{height:4rem}.w-full{width:100%}
.text-center{text-align:center}.mx-auto{margin-left:auto;margin-right:auto}
.px-6{padding-inline:1.5rem}.py-3{padding-block:.75rem}
.container{max-width:var(--container-7xl);margin:0 auto;padding:0 1rem}
nav.site-nav{position:fixed;inset-inline:0;top:0;background:var(--color-white);box-shadow:0 1px 2px rgba(0,0,0,.04);z-index:50}
.nav-row{display:flex;align-items:center;justify-content:space-between;height:64px;max-width:1200px;margin:0 auto;padding:0 16px}
.logo{font-weight:700;color:var(--color-blue-600);font-size:1.25rem}
.nav-links{display:flex;gap:20px;align-items:center}
.nav-links a{color:var(--color-gray-600);text-decoration:none}
.auth a{padding:8px 16px;border-radius:9999px;text-decoration:none}
.auth .primary{background:var(--color-blue-600);color:var(--color-white)}
.hero{padding-top:120px;padding-bottom:80px;background:linear-gradient(180deg,#f8fafc 0,#eef2ff 100%);text-align:center}
.card{max-width:700px;margin:0 auto;background:var(--color-white);padding:32px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.06)}
footer.site-footer{background:#0f172a;color:#cbd5e1;padding:48px 16px}
.site-footer a{color:inherit;text-decoration:none}

</style>

<style>
        :root {
            --deep-green: #3F1263;    /* primary */
            --brick-red: #986EAD;    /* primary-variant */
            --coral: #D8CBBB;        /* neutral */
            --mustard: #986EAD;      /* accent */
            --sky: #F2F2F2;          /* background */
            --rose: #D8CBBB;         /* neutral */
            --font-primary: 'Glacial Indifference', sans-serif;
            --font-secondary: 'Hanken Grotesk', sans-serif;
        }

body {
  font-family: var(--font-secondary);
  background: var(--sky);
  color: #222;
  margin: 0;
  padding: 0;
  display: flex;
  flex-direction: column;
  min-height: 100vh;
}

/* Header */
header {
  background-color: var(--deep-green);
  color: white;
  padding: 16px 10%;
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
}

header h1 {
  font-family: var(--font-primary);
  font-size: 1.6rem;
  margin: 0;
}

header .site-logo { height:44px; width:auto; margin-right:12px; }

nav a {
  color: white;
  text-decoration: none;
  margin-left: 18px;
  font-weight: 500;
  transition: opacity 0.2s;
}

nav a:hover {
  opacity: 0.8;
  text-decoration: underline;
}

/* Login Box */
.container {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 40px 20px;
}

.box {
  background: #fff;
  padding: 32px;
  border-radius: 16px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.08);
  width: 340px;
  text-align: center;
}

.box h3 {
  font-family: var(--font-primary);
  color: var(--brick-red);
  margin-bottom: 20px;
}

input {
  width: 100%;
  padding: 10px;
  margin-top: 10px;
  border-radius: 8px;
  border: 1px solid #ccc;
  font-family: var(--font-secondary);
}

button {
  margin-top: 20px;
  padding: 12px;
  width: 100%;
  background: var(--deep-green);
  color: #fff;
  border: 0;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  font-family: var(--font-secondary);
  transition: background 0.3s;
}

button:hover {
  background: var(--brick-red);
}

#msg {
  color: var(--brick-red);
  margin-top: 12px;
  font-size: 0.9rem;
}

footer {
  text-align: center;
  padding: 16px;
  background: var(--rose);
  color: #333;
  font-size: 0.9rem;
}

    .wrap{max-width:1200px;margin:0 auto}
    /* UPDATED: Changed card background to white, border to light gray */
    .card{background:#ffffff;padding:16px;border-radius:10px;margin-bottom:12px;border:1px solid #e0e0e0}
    /* Kept buttons similar, but adjusted text color for better contrast on light theme */
    button{padding:8px 10px;border-radius:8px;border:0;background:#06b6d4;color:#ffffff;cursor:pointer}
    /* UPDATED: Ghost button colors for light theme */
    .ghost{background:transparent;border:1px solid #ccc;color:#666}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    /* UPDATED: Table border and text color for light theme */
    th,td{padding:8px;text-align:left;border-bottom:1px dashed #eee;color:#333}
    /* UPDATED: Input field colors for light theme */
    input,select,textarea{padding:8px;border-radius:6px;border:1px solid #ccc;background:#ffffff;color:#333}
    /* UPDATED: Muted color for light theme */
    .muted{color:#888;font-size:13px}
    .med-form{display:flex;gap:8px;flex-wrap:wrap}
    .med-form > * { flex:1 1 220px; }
    .row{display:flex;gap:12px;align-items:center}
    .flex-1{flex:1}
    #chartWrap{display:flex;gap:18px;align-items:center;flex-wrap:wrap}
    /* UPDATED: Chart background for light theme */
    canvas{background:#fafafa; border-radius: 4px; padding: 6px;} 
    /* UPDATED: Panel background for light theme */
    .panel{background:#f0f3f5;padding:12px;border-radius:8px;margin-top:8px;border:1px solid #ddd}
    .small{font-size:13px}
    .hidden{display:none}

    /* Chat styles */
    .chat-messages{height:300px;overflow:auto;padding:10px;background:#fafafa;border-radius:8px;border:1px solid #eee}
    .chat-msg{max-width:78%;padding:8px 10px;border-radius:8px;margin-bottom:8px;font-size:0.95rem}
    .chat-msg.doctor{align-self:flex-start;background:#fff;border:1px solid #e6e6e6}
    .chat-msg.patient{align-self:flex-end;background:linear-gradient(180deg,#06b6d4,#0492af);color:#fff}
    /* Doctor chat input styles */
    .doctor-chat-row{display:flex;gap:8px;margin-top:8px;align-items:center}
    .doctor-chat-input{flex:1;padding:10px;border-radius:8px;border:1px solid #ccc;font-size:1rem}
    .doctor-chat-send{padding:8px 10px;border-radius:8px;background:#29423B;color:#fff;border:0;cursor:pointer;width:76px}

    /* Patient Details Resizable Grid */
    .pd-grid {
      display: grid;
      grid-template-columns: var(--pd-col-1-width) var(--pd-col-2-width);
      gap: 12px;
      position: relative;
      user-select: none;
      --pd-col-1-width: 50%; /* Default split */
      --pd-col-2-width: 50%;
    }

    /* Splitter style */
    .pd-splitter {
      width: 12px;
      height: 100%;
      position: absolute;
      top: 0;
      left: var(--pd-col-1-width);
      transform: translateX(-50%);
      cursor: col-resize;
      z-index: 10;
      /* UPDATED: Splitter colors for light theme */
      background: rgba(0, 0, 0, 0.05);
      border-left: 1px solid #ccc;
      border-right: 1px solid #ccc;
    }
    
    /* Chart Container Styling */
    .patient-chart-container {
        margin-top: 12px;
        margin-bottom: 12px;
    }

    /* Responsive stacking for patient details */
    @media (max-width: 768px) {
      .pd-grid {
        grid-template-columns: 1fr;
      }
      .pd-splitter {
        display: none;
      }
    }
 
</style>
<style>
/* Exact nav appearance overrides to match merged.html */
nav.fixed{font-family:Inter,ui-sans-serif,system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial,'Noto Sans',sans-serif}
nav.fixed .text-2xl{font-size:1.5rem;line-height:1;font-weight:700}
nav.fixed a, nav.fixed button{background:transparent!important;border:0!important;box-shadow:none!important;text-decoration:none!important;color:inherit!important;padding:0.5rem 0.75rem;font-size:1rem}
nav.fixed a:hover, nav.fixed button:hover{color:#2563eb!important}
nav.fixed a:focus, nav.fixed button:focus{outline:none!important;box-shadow:none!important}

/* Force dropdown vertical */
#navLoginMenuDoctor{position:absolute;right:0;top:100%;margin-top:0.5rem;width:11rem;background:#fff;border:1px solid #e5e7eb;border-radius:0.5rem;box-shadow:0 10px 15px rgba(0,0,0,.08);display:flex;flex-direction:column}
#navLoginMenuDoctor.hidden{display:none}
#navLoginMenuDoctor a{display:block;width:100%;padding:.5rem 1rem;text-align:left;color:var(--color-gray-700);text-decoration:none}
#navLoginMenuDoctor a:hover{background:#eff6ff;color:var(--color-blue-600)}
</style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
                <nav class="fixed top-0 left-0 right-0 bg-white shadow-sm z-50">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div class="flex items-center justify-between h-16">
                            <div class="flex-shrink-0"><span class="text-2xl font-bold text-blue-600">TYM</span></div>

                            <div class="flex items-center space-x-8">
                                <button class="text-gray-700 hover:text-blue-600 transition-colors" onclick="location.href='merged.html#home'">Home</button>
                                <button class="text-gray-700 hover:text-blue-600 transition-colors" onclick="location.href='merged.html#about'">About</button>
                                <button class="text-gray-700 hover:text-blue-600 transition-colors" onclick="location.href='merged.html#solutions'">Solutions</button>
                                <button class="text-gray-700 hover:text-blue-600 transition-colors" onclick="location.href='merged.html#contact'">Contact</button>
                            </div>

                            <div class="flex items-center space-x-4">
                                <div class="relative">
                                    <button id="navLoginBtnDoctor" class="px-4 py-2 text-blue-600 hover:text-blue-700 transition-colors">Login â–¾</button>
                                    <div id="navLoginMenuDoctor" class="hidden absolute right-0 mt-2 w-44 bg-white border rounded shadow-lg">
                                        <a class="block px-4 py-2 text-gray-700 hover:bg-blue-50" href="patient-login.html">Patient Login</a>
                                        <a class="block px-4 py-2 text-gray-700 hover:bg-blue-50" href="doctor-login.html">Doctor Login</a>
                                    </div>
                                </div>
                                <a class="px-6 py-2 bg-blue-600 text-white rounded-full" href="create-account.html">Sign Up</a>
                            </div>

                            <div class="md:hidden">
                                <button id="toggleBtnDoctor" class="text-gray-700 hover:text-blue-600">â˜°</button>
                            </div>
                        </div>
                    </div>

                    <div id="mobileMenuDoctor" class="md:hidden bg-white border-t" style="display:none;">
                        <div class="px-4 pt-2 pb-4 space-y-2">
                            <button onclick="location.href='merged.html#home'" class="block w-full text-left px-3 py-2 text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded">Home</button>
                            <button onclick="location.href='merged.html#about'" class="block w-full text-left px-3 py-2 text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded">About</button>
                            <button onclick="location.href='merged.html#solutions'" class="block w-full text-left px-3 py-2 text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded">Solutions</button>
                            <button onclick="location.href='merged.html#contact'" class="block w-full text-left px-3 py-2 text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded">Contact</button>
                            <div class="pt-4 space-y-2">
                                <a href="patient-login.html" class="block w-full px-4 py-2 text-blue-600 border border-blue-600 rounded-full hover:bg-blue-50">Patient Login</a>
                                <a href="doctor-login.html" class="block w-full px-4 py-2 text-gray-700 border rounded-full hover:bg-blue-50">Doctor Login</a>
                                <a href="create-account.html" class="block w-full px-4 py-2 bg-blue-600 text-white rounded-full">Sign Up</a>
                            </div>
                        </div>
                    </div>
                </nav>
<script>
;(function(){
    const btn = document.getElementById('navLoginBtnDoctor');
    const menu = document.getElementById('navLoginMenuDoctor');
    let _close = null;
    if (btn && menu) {
        btn.setAttribute('aria-haspopup','true');
        btn.setAttribute('aria-expanded','false');

        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const isHidden = menu.classList.contains('hidden');
            if (isHidden) {
                const rect = btn.getBoundingClientRect();
                menu.style.position = 'fixed';
                menu.style.left = (rect.right - menu.offsetWidth) + 'px';
                menu.style.top = (rect.bottom) + 'px';
                menu.style.zIndex = '9999';
                menu.classList.remove('hidden');
                menu.style.display = 'block';
                btn.setAttribute('aria-expanded','true');
                setTimeout(()=>document.addEventListener('click', _close = (ev)=>{ if(!menu.contains(ev.target) && ev.target!==btn){ menu.classList.add('hidden'); menu.style.display='none'; btn.setAttribute('aria-expanded','false'); document.removeEventListener('click', _close); _close=null; } }));
            } else {
                menu.classList.add('hidden'); menu.style.display='none'; btn.setAttribute('aria-expanded','false'); if(_close){ document.removeEventListener('click', _close); _close=null; }
            }
        });

        document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && !menu.classList.contains('hidden')){ menu.classList.add('hidden'); menu.style.display='none'; btn.setAttribute('aria-expanded','false'); if(_close){ document.removeEventListener('click', _close); _close=null; } }});
    }
    const toggleBtn = document.getElementById('toggleBtnDoctor');
    const mobile = document.getElementById('mobileMenuDoctor');
    if(toggleBtn && mobile){ toggleBtn.addEventListener('click', ()=>{ if(mobile.style.display==='none'){ mobile.style.display=''; toggleBtn.textContent='âœ•'; } else { mobile.style.display='none'; toggleBtn.textContent='â˜°'; }}); }
})();
</script>
  <div class="wrap">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <h2 style="margin:0">Doctor Dashboard</h2>
          <div id="who" class="muted"></div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="refresh" class="ghost">Refresh</button>
          <button id="logout" class="ghost">Logout</button>
        </div>
      </div>
    </div>

        <div style="display:flex;gap:8px;align-items:center;margin:14px 0">
            <button id="docTabOverview" class="ghost">Overview</button>
            <button id="docTabChat">Chat</button>
        </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap">
        <div style="flex:1;min-width:320px">
          <h3 style="margin:0">Overall Adherence (All Assigned Patients)</h3>
          <div id="chartWrap">
            <div style="width:260px;height:260px">
              <canvas id="overallChart"></canvas>
            </div>
            <div class="flex-1">
              <div class="muted">Totals (Assigned Patients)</div>
              <table style="max-width:420px">
                <tr><th>Metric</th><th>Value</th></tr>
                <tr><td>Total Patients</td><td id="totalPatients">0</td></tr>
                <tr><td>Total Events</td><td id="totalEvents">0</td></tr>
                <tr><td>Taken</td><td id="totalTaken">0</td></tr>
                <tr><td>Missed (proxy)</td><td id="totalMissed">0</td></tr>
                <tr><td>Avg adherence (proxy)</td><td id="avgAdherence">â€”</td></tr>
              </table>
            </div>
          </div>
        </div>

        <div style="width:320px;min-width:260px">
          <h3 style="margin:0">Select Patient</h3>
          <div style="margin-top:8px;display:flex;gap:8px">
            <select id="patientSelector" style="flex:1;padding:8px;border-radius:6px;background:#ffffff;color:#333;border:1px solid #ccc"></select>
            <button id="viewPatient" title="Open patient details">View</button>
          </div>
          <div class="muted" style="margin-top:8px">Choose an approved patient assigned to you.</div>
        </div>
      </div>
    </div>

    <div class="card" id="approvals">
      <h3 style="margin:0">Pending Patient Approvals</h3>
      <div id="pendingWrap" style="margin-top:10px" class="muted">Loading...</div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">Patient Details</h3>
        <div class="muted" id="detailNote">Select a patient and click <strong>View</strong></div>
      </div>

      <div id="patientPanel" class="panel hidden">
        <div class="pd-grid">
          <div id="pd-col-1" style="min-width:260px">
            <div class="muted">Patient</div>
            <div id="pd_name" style="font-weight:700;font-size:18px">â€”</div>
            <div class="muted" id="pd_assigned">Assigned doctor: â€”</div>
            <div style="margin-top:10px">
              <button id="exportPatientCSV" class="ghost">Export Patient CSV</button>
              <button id="closePatient" class="ghost" style="margin-left:8px">Close</button>
            </div>

            <div class="patient-chart-container">
              <div class="muted" id="pd_stats" style="margin-bottom:6px"></div>
              
              <h4 style="margin:8px 0">Taken vs Missed (7d)</h4>
              <div style="width:180px;height:180px;"><canvas id="patientPieChart"></canvas></div>

              <h4 style="margin:12px 0 8px 0">Daily Trend (7d)</h4>
              <canvas id="patientDailyTrendChart"></canvas>

              <h4 style="margin:12px 0 8px 0">Adherence by Medication (7d)</h4>
              <canvas id="patientMedBarChart"></canvas>
              
              <h4 style="margin:12px 0 8px 0">AM vs PM Adherence (7d)</h4>
              <canvas id="patientAmPmChart"></canvas>
            </div>
          </div>

          <div id="pd-splitter" class="pd-splitter"></div>

          <div id="pd-col-2" style="min-width:260px;overflow:hidden">
            <div class="muted">Medications</div>
            <div id="pd_meds" style="margin-top:8px"></div>

            <div style="margin-top:12px">
              <div class="muted">Recent Events</div>
              <div id="pd_events" style="margin-top:8px"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

        <div class="card" id="doctorChatCard">
            <h3 style="margin:0">Doctor Chat</h3>
            <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
                <select id="chatPatientSelector" style="flex:1;padding:8px;border-radius:6px;background:#ffffff;color:#333;border:1px solid #ccc"></select>
                <button id="openChat">Open</button>
                <button id="clearChatDoc" class="ghost">Clear</button>
            </div>
            <div id="doctorChat" class="panel hidden" style="margin-top:10px">
                <div id="doctorChatMessages" class="chat-messages"></div>
                <div class="doctor-chat-row">
                    <input id="doctorChatInput" class="doctor-chat-input" placeholder="Type a message..." />
                    <button id="doctorChatSend" class="doctor-chat-send">Send</button>
                </div>
            </div>

        </div>

        <div class="card">
            <h3 style="margin:0">Add Medication for a Patient</h3>
      <div style="margin-top:8px" class="med-form">
        <select id="selectPatient"><option value="">-- select patient --</option></select>
        <input id="d_medName" placeholder="Medication name" />
        <select id="d_medType"><option value="pill">Pill</option><option value="liquid">Liquid</option><option value="injection">Injection</option><option value="other">Other</option></select>
        <input id="d_medDose" placeholder="Dosage (e.g., 10 mg)" />
        <select id="d_medSchedule"><option value="am">AM</option><option value="pm">PM</option><option value="both">Both</option><option value="custom">Custom</option></select>
        <input id="d_medInstr" placeholder="Instructions (take with meal...)" />
        <button id="d_addMedBtn">Add Medication (doctor)</button>
      </div>
      <div class="muted" style="margin-top:8px">Doctors can assign meds to any approved patient assigned to them.</div>
    </div>

    <div class="card">
      <h3 style="margin:0">Patients & Med Summary (Assigned)</h3>
      <div id="patientSummary" style="margin-top:8px"></div>
    </div>

    <div class="card">
      <h3 style="margin:0">Medication Management (Edit/Delete)</h3>
      <div id="medManagement" style="margin-top:8px"></div>
    </div>

    <div class="card">
      <h3 style="margin:0">Adherence Logs (Assigned Patients)</h3>
      <div id="logs" style="margin-top:8px"></div>
    </div>
  </div>
<script>
/* Inlined _storage.js to avoid bundler 404/MIME issues when loaded inside WebView */

/* ============================================================
 * storage.js
 * FINAL FIX FOR REDECLARATION ERROR
 * ============================================================ */

// 1. Internal Constant Declaration (This must be the only place it is declared)
const STORAGE_KEY_PREFIX = 'TYMI_'; 

// 2. SAFELY determine the execution environment
const isBrowser = typeof window !== 'undefined' && typeof document !== 'undefined';
const isReactNativeWebView = isBrowser && !!window.ReactNativeWebView;

// 3. Promise Queue for Asynchronous getItem Resolution (WebView only)
const nativeStorageQueue = {}; 

function generateTransactionId() {
    return Math.random().toString(36).substring(2, 15);
}

// Global function called by the React Native side 
function resolveNativeStorageResponse(message) {
    if (message.type !== 'STORAGE_RESPONSE') return;
    const { txId, value, error } = message;
    const promiseHandlers = nativeStorageQueue[txId];

    if (promiseHandlers) {
        delete nativeStorageQueue[txId];
        if (error) {
            console.error(`WebView Storage Error (Tx:${txId}):`, error);
            promiseHandlers.reject(new Error(error));
        } else {
            promiseHandlers.resolve(value); 
        }
    }
}

// Sends a storage operation request to the native side
function sendNativeStorageRequest(action, key, value = null) {
    if (!isReactNativeWebView) {
        return Promise.reject(new Error("Attempted native storage outside WebView."));
    }

    const txId = generateTransactionId();

    return new Promise((resolve, reject) => {
        // ðŸ”‘ FIX: Store ALL promises in the queue, regardless of action.
        // This forces the JS to wait until the native side sends a response.
        nativeStorageQueue[txId] = { resolve, reject };

        try {
            console.log(`[WebView] Sending ${action} request for key: ${key}, TxID: ${txId}`);
            
            window.ReactNativeWebView.postMessage(
                JSON.stringify({
                    type: "STORAGE_OPERATION",
                    action: action,
                    key: key,
                    value: value,
                    txId: txId, 
                })
            );
        } catch (e) {
            // Clean up the promise queue if the postMessage itself failed
            if (nativeStorageQueue[txId]) delete nativeStorageQueue[txId]; 
            console.error("Failed to send native storage request:", e);
            reject(e);
        }
    });
}


/* ------------------------------------------------ */
/* --- EXPORTED ASYNCHRONOUS FUNCTIONS --- */
/* ------------------------------------------------ */

async function getItem(key) {
    const fullKey = STORAGE_KEY_PREFIX + key;
    if (!isBrowser) return null;
    
    if (isReactNativeWebView) {
        return sendNativeStorageRequest('getItem', fullKey);
    } else {
        return Promise.resolve(localStorage.getItem(fullKey));
    }
}

async function setItem(key, value) {
    const fullKey = STORAGE_KEY_PREFIX + key;
    if (!isBrowser) return;

    if (isReactNativeWebView) {
        return sendNativeStorageRequest('setItem', fullKey, value);
    } else {
        localStorage.setItem(fullKey, value);
        return Promise.resolve();
    }
}

async function removeItem(key) {
    const fullKey = STORAGE_KEY_PREFIX + key;
    if (!isBrowser) return;

    if (isReactNativeWebView) {
        return sendNativeStorageRequest('removeItem', fullKey);
    } else {
        localStorage.removeItem(fullKey);
        return Promise.resolve();
    }
}

/* ------------------------------------------------ */
/* --- GLOBAL SCOPE INITIALIZATION (Client Only) --- */
/* ------------------------------------------------ */

// 4. Create a global Storage object for easy access in other dashboard scripts
if (isBrowser) {
    // Assign the exports to the global window object for use in the static HTML file
    window.Storage = {
        getItem: getItem,
        setItem: setItem,
        removeItem: removeItem,
    };

    // Attach the global listener for native replies
    if (isReactNativeWebView) {
    // âš ï¸ CRITICAL FIX: Listen on the window object for the event dispatched by RN.
    window.addEventListener('message', (event) => {
        try {
            // event.data may be a JSON string or already an object depending on
            // how the native side injected the message. Handle both.
            let data = event.data;
            if (typeof data === 'string') {
                data = JSON.parse(data);
            }

            if (data && data.type === 'STORAGE_RESPONSE') {
                resolveNativeStorageResponse(data);
            }
        } catch (e) {
            console.error("Error parsing native response in listener:", e);
        }
    });
}
}

</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
/* -------------------------
    Storage helpers (Async Proxy)
    ------------------------- */
function uid(){ return Math.random().toString(36).slice(2,9); }

// All storage functions are now ASYNCHRONOUS and use window.Storage
async function loadUsers(){ 
    try{
        const json = await window.Storage.getItem('users');
        return JSON.parse(json || '[]');
    }catch(e){ return [] } 
}
async function saveUsers(u){ 
    await window.Storage.setItem('users', JSON.stringify(u)); 
}

async function loadLogs(){ 
    try{
        const json = await window.Storage.getItem('adherenceLogs');
        return JSON.parse(json || '{}');
    }catch(e){ return {} } 
}
async function saveLogs(l){ 
    await window.Storage.setItem('adherenceLogs', JSON.stringify(l)); 
}

async function loadMeds(){ 
    try{
        const json = await window.Storage.getItem('medications');
        return JSON.parse(json || '{}');
    }catch(e){ return {} } 
}
async function saveMeds(m){ 
    await window.Storage.setItem('medications', JSON.stringify(m)); 
}

/* -------------------------
    Global State & Auth Check
    ------------------------- */
let current = null; // Current logged-in username
let role = null;    // Current logged-in role

// --- Sample Data Definitions ---
const SAMPLE_PATIENT = 'patient1';
const SAMPLE_DOCTOR = 'doctor1';

const sampleMeds_patient1 = [
  { id: "med1", name: "Metformin", type: "pill", dosage: "500 mg", schedule: "am", instructions: "Take with breakfast", assignedBy: "doctor" },
  { id: "med2", name: "Lisinopril", type: "pill", dosage: "10 mg", schedule: "pm", instructions: "Take before bed", assignedBy: "doctor" },
  { id: "med3", name: "Insulin", type: "injection", dosage: "5 units", schedule: "both", instructions: "Inject with meals", assignedBy: "doctor" },
];

// --- Sample Data Generation Function ---
async function generateAdherenceData(patientId, medsList) {
    let logs = await loadLogs(); // AWAIT
    logs[patientId] = [];
    const today = new Date();
    
    // Generate logs for the last 7 days
    for (let i = 6; i >= 0; i--) { 
        const date = new Date(today);
        date.setDate(today.getDate() - i);
        
        medsList.forEach(med => {
            const prob = (med.schedule === "pm") ? 0.7 : 0.8; 
            
            // Log for AM dose (if applicable)
            if ((med.schedule === 'am' || med.schedule === 'both') && Math.random() < prob) {
                logs[patientId].push({
                    ts: new Date(date.getFullYear(), date.getMonth(), date.getDate(), 8, 0, 0).toISOString(),
                    type: "taken", medId: med.id, medName: med.name, schedule: 'am',
                    note: med.instructions, by: patientId
                });
            }
            
            // Log for PM dose (if applicable)
            if ((med.schedule === 'pm' || med.schedule === 'both') && Math.random() < prob) {
                logs[patientId].push({
                    ts: new Date(date.getFullYear(), date.getMonth(), date.getDate(), 20, 0, 0).toISOString(),
                    type: "taken", medId: med.id, medName: med.name, schedule: 'pm',
                    note: med.instructions, by: patientId
                });
            }
        });
    }
    await saveLogs(logs); // AWAIT
}

/* -------------------------
    Seed demo 
    ------------------------- */
async function seedDemo(){ // ASYNC
    let users = await loadUsers(); // AWAIT
    let medsStore = await loadMeds(); // AWAIT
    
    // 1. Ensure Doctor and Patient accounts exist
    if(!users.find(u=>u.username===SAMPLE_DOCTOR)){
        users.push({username:SAMPLE_DOCTOR,password:'docpass',role:'doctor',approved:true,pendingPatients:[]});
    }
    if(!users.find(u=>u.username===SAMPLE_PATIENT)){
        users.push({
            username:SAMPLE_PATIENT,
            password:'patpass',
            role:'patient',
            approved:true, 
            preferredDoctor:SAMPLE_DOCTOR,
            assignedDoctor:SAMPLE_DOCTOR
        });
    }
    await saveUsers(users); // AWAIT

    // 2. Ensure Medications and Logs for patient1 exist
    if(!medsStore[SAMPLE_PATIENT] || medsStore[SAMPLE_PATIENT].length === 0){
        medsStore[SAMPLE_PATIENT] = sampleMeds_patient1.map(m => ({ ...m, addedBy: 'doctor:' + SAMPLE_DOCTOR }));
        await saveMeds(medsStore); // AWAIT
        
        await generateAdherenceData(SAMPLE_PATIENT, medsStore[SAMPLE_PATIENT]); // AWAIT
    }
}

/* -------------------------
    Doctor Chat helpers
    ------------------------- */
    async function getDoctorId(){ return current || SAMPLE_DOCTOR; }
    async function chatKeyFor(patientUsername){ const d = await getDoctorId(); return `chat_${patientUsername}_${d}`; }
    async function loadChatMessages(patientUsername){
        try{
            const key = await chatKeyFor(patientUsername);
            if (window.Storage && typeof window.Storage.getItem === 'function'){
                const json = await window.Storage.getItem(key);
                return JSON.parse(json||'[]');
            }
            // fallback to localStorage to match patient dashboard
            return JSON.parse(localStorage.getItem(key) || '[]');
        }catch(e){return []}
    }
    async function saveChatMessages(patientUsername, msgs){
        const key = await chatKeyFor(patientUsername);
        try{
            if (window.Storage && typeof window.Storage.setItem === 'function'){
                await window.Storage.setItem(key, JSON.stringify(msgs));
            }
        }catch(e){
            console.warn('window.Storage unavailable, falling back to localStorage');
        }
        // Ensure patient UI (which reads localStorage) also sees messages
        try{ localStorage.setItem(key, JSON.stringify(msgs)); }catch(e){}
        // update unread badge after saving
        try{ updateUnreadBadge(); }catch(e){}
    }
    async function renderDoctorChat(patientUsername){ const wrap = document.getElementById('doctorChatMessages'); if(!wrap) return; const msgs = await loadChatMessages(patientUsername); wrap.innerHTML = ''; msgs.forEach(m=>{ const el = document.createElement('div'); el.className = 'chat-msg ' + (m.sender==='patient' ? 'patient' : 'doctor'); el.innerHTML = `<div>${escapeHtml(m.text)}</div><div class="muted" style="font-size:0.75rem;margin-top:6px">${new Date(m.time).toLocaleString()}</div>`; wrap.appendChild(el); }); wrap.scrollTop = wrap.scrollHeight; }
    async function sendDoctorChat(patientUsername, text){ if(!patientUsername || !text || !text.trim()) return; const msgs = await loadChatMessages(patientUsername); msgs.push({ id: uid(), sender: 'doctor', text: text.trim(), time: new Date().getTime() }); await saveChatMessages(patientUsername, msgs); await renderDoctorChat(patientUsername); }
    async function sendDoctorChat(patientUsername, text){
        try{
            if(!patientUsername || !text || !text.trim()) return;
            const msgs = await loadChatMessages(patientUsername);
            msgs.push({ id: uid(), sender: 'doctor', text: text.trim(), time: new Date().getTime() });
            await saveChatMessages(patientUsername, msgs);
            await renderDoctorChat(patientUsername);
        }catch(e){ console.error('sendDoctorChat error', e); throw e; }
    }
    let doctorChatPoll = null;
    function startDoctorChatPolling(patientUsername){ stopDoctorChatPolling(); doctorChatPoll = setInterval(()=>{ renderDoctorChat(patientUsername); }, 2000); }
    function stopDoctorChatPolling(){ if(doctorChatPoll){ clearInterval(doctorChatPoll); doctorChatPoll = null; } }
    async function clearDoctorChat(patientUsername){
        const key = await chatKeyFor(patientUsername);
        try{ if(window.Storage && typeof window.Storage.removeItem === 'function') await window.Storage.removeItem(key); }catch(e){}
        try{ localStorage.removeItem(key); }catch(e){}
        await renderDoctorChat(patientUsername);
    }

    function escapeHtml(str){ if(!str) return ''; return String(str).replace(/[&<>\"']/g, function(s){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[s]; }); }

    /* -------------------------
        Unread badge + last-seen helpers
       ------------------------- */
    async function lastSeenKeyFor(patientUsername){ const d = await getDoctorId(); return `chatLastSeen_${patientUsername}_${d}`; }
    async function setLastSeenForPatient(patientUsername){ try{ const key = await lastSeenKeyFor(patientUsername); const ts = Date.now().toString(); if(window.Storage && typeof window.Storage.setItem==='function'){ await window.Storage.setItem(key, ts); } localStorage.setItem(key, ts); }catch(e){console.error('setLastSeen error',e);} }
    async function getLastSeenForPatient(patientUsername){ try{ const key = await lastSeenKeyFor(patientUsername); if(window.Storage && typeof window.Storage.getItem==='function'){ const v = await window.Storage.getItem(key); if(v) return Number(v); } const v2 = localStorage.getItem(key); if(v2) return Number(v2); }catch(e){ } return 0; }

    async function getUnreadCountForPatient(patientUsername){ try{ const msgs = await loadChatMessages(patientUsername); const last = await getLastSeenForPatient(patientUsername) || 0; return msgs.filter(m => m.sender==='patient' && Number(m.time) > Number(last)).length; }catch(e){ return 0; } }

    let unreadPoll = null;
    async function updateUnreadBadge(){ try{
        const sel = document.getElementById('chatPatientSelector');
        let patients = [];
        if (sel && sel.options.length>0) {
            for (let i=0;i<sel.options.length;i++){ const v = sel.options[i].value; if(v) patients.push(v); }
        } else {
            const users = await loadUsers(); patients = users.filter(u=>u.role==='patient' && u.approved && u.assignedDoctor===current).map(u=>u.username);
        }
        let total = 0;
        for (const p of patients) { total += await getUnreadCountForPatient(p); }
        const tab = document.getElementById('docTabChat');
        if(tab){ tab.textContent = total>0 ? `Chat (${total})` : 'Chat'; }
    }catch(e){ console.error('updateUnreadBadge', e); } }
    function startUnreadPolling(){ stopUnreadPolling(); unreadPoll = setInterval(()=>{ updateUnreadBadge(); }, 2500); }
    function stopUnreadPolling(){ if(unreadPoll){ clearInterval(unreadPoll); unreadPoll = null; } }


/* -------------------------
    Basic async auth guard
    ------------------------- */
async function checkAuthAndInit() {
    const currentJSON = await window.Storage.getItem('currentUser');
    const roleString = await window.Storage.getItem('currentRole');

    // Parse current user from the stringified JSON stored in the login step
    try {
        current = JSON.parse(currentJSON)?.username || null;
    } catch (e) {
        current = null;
    }
    role = roleString;

    if(!current || role !== 'doctor'){ 
        alert('Not logged in as doctor'); 
        window.location.href='doctor-login.html'; 
        return; 
    }

    // After successful auth, display username
    const whoElement = document.getElementById('who');
    if (whoElement) {
        whoElement.textContent = 'Logged in as: ' + current;
    }

    // Run seeding and then the main dashboard UI refresh
    await seedDemo();
    await refreshUI(); 
    
    // Auto-select and open patient1 for demonstration
    document.getElementById('patientSelector').value = 'patient1';
    await openPatientPanel('patient1');
}

// ----------------------------------------------------
// Chart objects & Instances
// ----------------------------------------------------
let overallChart = null;
let patientPieChart = null;
let patientDailyTrendChart = null;
let patientMedBarChart = null;
let patientAmPmChart = null;

const chartColors = {
    taken: '#2d9f6b',
    missed: '#ef4444',
    assigned: '#06b6d4'
};


function buildOverallChart(taken, missed){
    const ctx = document.getElementById('overallChart').getContext('2d');
    if(overallChart) overallChart.destroy();
    overallChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: ['Taken','Missed (proxy)'],
            datasets: [{
                data: [taken, missed],
                backgroundColor: [chartColors.taken, chartColors.missed],
                hoverOffset: 6
            }]
        },
        options: {
            plugins: { legend: { position: 'bottom', labels: { color: '#333' } } },
            responsive: true,
            maintainAspectRatio: true 
        }
    });
}

/**
 * Builds all 4 patient-specific charts for the given patient.
 */
async function buildPatientCharts(username){ // ASYNC
    const logs = await loadLogs(); // AWAIT
    const meds = await loadMeds(); // AWAIT
    
    const patientLogs = logs[username] || [];
    const patientMeds = meds[username] || [];
    
    // --- Data Processing for Charts (Last 7 Days) ---
    const sevenDaysAgo = new Date();
    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
    
    const dailyData = {};
    const today = new Date();
    
    // 1. Initialize data for the last 7 days (date strings in YYYY-MM-DD format)
    for (let i = 6; i >= 0; i--) { 
        const d = new Date(today);
        d.setDate(today.getDate() - i);
        const dateStr = d.toISOString().split('T')[0];
        dailyData[dateStr] = { assigned: 0, taken: 0 };
    }

    // Calculate assigned doses for the 7-day period
    patientMeds.forEach(m => {
        for (const dateStr in dailyData) {
            dailyData[dateStr].assigned += (m.schedule === 'both' ? 2 : 1);
        }
    });

    // Filter and count taken doses for the 7-day period
    patientLogs.filter(l => new Date(l.ts) >= sevenDaysAgo).forEach(l => {
        const dateStr = new Date(l.ts).toISOString().split('T')[0];
        if (dailyData[dateStr]) {
            dailyData[dateStr].taken++;
        }
    });

    const dailyLabels = Object.keys(dailyData).map(d => new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
    const dailyTaken = Object.values(dailyData).map(d => d.taken);
    const dailyAssigned = Object.values(dailyData).map(d => d.assigned);
    
    // 2. Taken vs Missed Data (Overall Adherence for the 7-day period)
    const totalAssigned = dailyAssigned.reduce((a, b) => a + b, 0);
    const totalTaken = dailyTaken.reduce((a, b) => a + b, 0);
    const totalMissed = Math.max(0, totalAssigned - totalTaken); 
    
    // Update stats display
    document.getElementById('pd_stats').textContent = `Taken (7d): ${totalTaken} â€¢ Missed (est): ${totalMissed} â€¢ Total Logs: ${patientLogs.length}`;


    // 3. Adherence by Medication (Bar Chart - Last 7 days)
    const medAdherence = {};
    patientMeds.forEach(m => {
        medAdherence[m.name] = { id: m.id, assigned: 7 * (m.schedule === 'both' ? 2 : 1), taken: 0 }; 
    });

    patientLogs.filter(l => new Date(l.ts) >= sevenDaysAgo).forEach(l => {
        const med = medAdherence[l.medName];
        if(med) med.taken++;
    });
    
    const medBarLabels = Object.keys(medAdherence);
    const medBarData = medBarLabels.map(name => {
        const m = medAdherence[name];
        return m.assigned > 0 ? (m.taken / m.assigned * 100) : 0; 
    });
    
    // 4. AM vs PM Adherence (Last 7 days)
    let amAssigned = 0;
    let pmAssigned = 0;
    patientMeds.forEach(m => {
        if (m.schedule === 'am' || m.schedule === 'both') amAssigned += 7;
        if (m.schedule === 'pm' || m.schedule === 'both') pmAssigned += 7;
    });

    const recentLogs = patientLogs.filter(l => new Date(l.ts) >= sevenDaysAgo);

    const amTaken = recentLogs.filter(l => l.schedule === 'am' || (l.schedule === 'both' && new Date(l.ts).getHours() < 12)).length;
    const pmTaken = recentLogs.filter(l => l.schedule === 'pm' || (l.schedule === 'both' && new Date(l.ts).getHours() >= 12)).length;

    const amAdherence = amAssigned > 0 ? amTaken / amAssigned * 100 : 0;
    const pmAdherence = pmAssigned > 0 ? pmTaken / pmAssigned * 100 : 0;


    // --- Chart Drawing ---
    
    // 1. Patient Pie Chart (Taken vs Missed)
    const ctxPie = document.getElementById('patientPieChart').getContext('2d');
    if (patientPieChart) patientPieChart.destroy();
    patientPieChart = new Chart(ctxPie, {
        type: 'doughnut',
        data: {
            labels: ['Taken','Missed (est)'],
            datasets: [{ data: [totalTaken, totalMissed], backgroundColor: [chartColors.taken, chartColors.missed] }]
        },
        options: { cutout: '60%', plugins: { legend: { display: false } }, responsive: true, maintainAspectRatio: true }
    });

    // 2. Patient Daily Trend Chart (Line)
    const ctxDaily = document.getElementById('patientDailyTrendChart').getContext('2d');
    if (patientDailyTrendChart) patientDailyTrendChart.destroy();
    patientDailyTrendChart = new Chart(ctxDaily, {
        type: 'line',
        data: {
            labels: dailyLabels,
            datasets: [
                { label: 'Assigned', data: dailyAssigned, borderColor: chartColors.assigned, fill: false, tension: 0.1 },
                { label: 'Taken', data: dailyTaken, borderColor: chartColors.taken, fill: false, tension: 0.1 }
            ]
        },
        options: { maintainAspectRatio: true, plugins: { legend: { labels: { color: '#666' } } }, scales: { x: { ticks: { color: '#666' } }, y: { ticks: { color: '#666' } } } }
    });

    // 3. Adherence by Medication (Bar Chart)
    const ctxMedBar = document.getElementById('patientMedBarChart').getContext('2d');
    if (patientMedBarChart) patientMedBarChart.destroy();
    patientMedBarChart = new Chart(ctxMedBar, {
        type: 'bar',
        data: {
            labels: medBarLabels,
            datasets: [{
                label: 'Adherence (%)',
                data: medBarData,
                backgroundColor: chartColors.assigned,
            }]
        },
        options: { 
            maintainAspectRatio: true,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true, max: 100, ticks: { color: '#666' } }, x: { ticks: { color: '#666' } } }
        }
    });
    
    // 4. AM vs PM Adherence (Bar Chart)
    const ctxAmPm = document.getElementById('patientAmPmChart').getContext('2d');
    if (patientAmPmChart) patientAmPmChart.destroy();
    patientAmPmChart = new Chart(ctxAmPm, {
        type: 'bar',
        data: {
            labels: ['AM', 'PM'],
            datasets: [{
                label: 'Adherence (%)',
                data: [amAdherence, pmAdherence],
                backgroundColor: [chartColors.taken, chartColors.assigned],
            }]
        },
        options: { 
            maintainAspectRatio: true,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true, max: 100, ticks: { color: '#666' } }, x: { ticks: { color: '#666' } } }
        }
    });
}


/* -------------------------
    Compute overall adherence & update UI
    ------------------------- */
async function computeOverall(){ // ASYNC
    const users = await loadUsers(); // AWAIT
    const logs = await loadLogs(); // AWAIT

    const assignedPatients = users.filter(u=>u.role==='patient' && u.approved && u.assignedDoctor === current); 
    let overallTaken = 0, overallEvents = 0;
    
    assignedPatients.forEach(p=>{
        const evs = logs[p.username] || [];
        overallTaken += evs.filter(e=>e.type==='taken').length;
        overallEvents += evs.length;
    });
    
    const overallMissed = overallEvents - overallTaken; 
    const avgAdh = overallEvents ? Math.round((overallTaken/overallEvents)*100) : 'â€”';
    
    document.getElementById('totalPatients').textContent = assignedPatients.length;
    document.getElementById('totalEvents').textContent = overallEvents;
    document.getElementById('totalTaken').textContent = overallTaken;
    document.getElementById('totalMissed').textContent = overallMissed;
    document.getElementById('avgAdherence').textContent = (avgAdh==='â€”'? 'â€”' : avgAdh + '%');
    buildOverallChart(overallTaken, overallMissed);
}

/* -------------------------
    Pending approvals
    ------------------------- */
async function renderPending(){ // ASYNC
    const users = await loadUsers(); // AWAIT
    const pending = users.filter(u=>u.role==='patient' && !u.approved && u.preferredDoctor === current);
    const container = document.getElementById('pendingWrap');
    if(pending.length===0){ container.innerHTML = '<div class="muted">No pending requests for you</div>'; return; }
    container.innerHTML = '<table><tr><th>Username</th><th>Action</th></tr>' + pending.map(p=>{
        return `<tr><td>${p.username}</td><td><button onclick="approve('${p.username}')">Approve & Assign</button></td></tr>`;
    }).join('') + '</table>';
}

async function approve(username){ // ASYNC
    const users = await loadUsers(); const u = users.find(x=>x.username===username); // AWAIT
    if(!u) return alert('User missing');
    u.approved = true; u.assignedDoctor = current; 
    
    // Update doctor's pending list (if stored, though not explicitly used here)
    users.forEach(doc=>{
        if(doc.role==='doctor' && Array.isArray(doc.pendingPatients)){
            doc.pendingPatients = doc.pendingPatients.filter(p=>p !== username);
        }
    });

    await saveUsers(users); // AWAIT
    
    const meds = await loadMeds(); // AWAIT
    if(!meds[username]) meds[username]=[]; 
    await saveMeds(meds); // AWAIT
    
    await renderPending(); await refreshUI(); // AWAIT calls
}

/* -------------------------
    Patient selector + Patient details panel
    ------------------------- */
async function getPatientAdherence(username){ // ASYNC
    const logs = await loadLogs(); // AWAIT
    const meds = await loadMeds(); // AWAIT

    const arr = logs[username] || [];
    const patientMeds = meds[username] || [];
    
    const sevenDaysAgo = new Date();
    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
    const recentLogs = arr.filter(e => new Date(e.ts) >= sevenDaysAgo);
    
    const taken = recentLogs.filter(e=>e.type==='taken').length;
    
    let assignedDoses = 0;
    patientMeds.forEach(m => {
        assignedDoses += 7 * (m.schedule === 'both' ? 2 : 1);
    });
    
    const missed = Math.max(0, assignedDoses - taken);
    
    return { taken, missed, totalEvents: arr.length };
}

async function populatePatientSelector(){ // ASYNC
    const users = await loadUsers(); // AWAIT
    const sel = document.getElementById('patientSelector'); 
    sel.innerHTML = '<option value="">-- select patient --</option>';
    users.filter(u=>u.role==='patient' && u.approved && u.assignedDoctor === current).forEach(p=>{
        const opt = document.createElement('option'); opt.value = p.username; opt.textContent = p.username; sel.appendChild(opt);
    });
}

async function fillDoctorPatientSelect(){ // ASYNC
    const users = await loadUsers(); // AWAIT
    const sel = document.getElementById('selectPatient'); 
    sel.innerHTML = '<option value="">-- select patient --</option>';
    users.filter(u=>u.role==='patient' && u.approved && u.assignedDoctor === current).forEach(p=>{
        const opt = document.createElement('option'); opt.value = p.username; opt.textContent = p.username; sel.appendChild(opt);
    });
}

async function populateChatPatientSelector(){
    const users = await loadUsers();
    const sel = document.getElementById('chatPatientSelector');
    if(!sel) return;
    sel.innerHTML = '<option value="">-- select patient --</option>';
    users.filter(u=>u.role==='patient' && u.approved && u.assignedDoctor === current).forEach(p=>{
        const opt = document.createElement('option'); opt.value = p.username; opt.textContent = p.username; sel.appendChild(opt);
    });
}

document.getElementById('viewPatient').addEventListener('click', async ()=>{ // ASYNC
    const username = document.getElementById('patientSelector').value;
    if(!username) return alert('Choose a patient');
    await openPatientPanel(username); // AWAIT
});

document.getElementById('closePatient').addEventListener('click', ()=>{ 
    document.getElementById('patientPanel').classList.add('hidden'); 
});

async function openPatientPanel(username){ // ASYNC
    const users = await loadUsers(); // AWAIT
    const patient = users.find(u=>u.username===username && u.role==='patient');
    if(!patient) return alert('Patient not found');
    document.getElementById('patientPanel').classList.remove('hidden');
    document.getElementById('pd_name').textContent = patient.username;
    document.getElementById('pd_assigned').textContent = 'Assigned doctor: ' + (patient.assignedDoctor||'â€”');
    
    await renderPatientMeds(username); // AWAIT
    await renderPatientEvents(username); // AWAIT
    
    await buildPatientCharts(username); // AWAIT
    // Auto-select patient in chat selector
    try{
        const chatSel = document.getElementById('chatPatientSelector');
        if (chatSel) chatSel.value = username;

        // If Chat tab is active, open chat for this patient automatically
        const chatTab = document.getElementById('docTabChat');
        if (chatTab && chatTab.classList.contains('ghost')) {
            document.getElementById('doctorChat').classList.remove('hidden');
            await renderDoctorChat(username);
            setLastSeenForPatient(username); // mark as read
            startDoctorChatPolling(username);
        }
        // update unread badge after selection
        updateUnreadBadge();
    }catch(e){ console.error('Auto-select chat error', e); }
}

/* export patient CSV */
document.getElementById('exportPatientCSV').addEventListener('click', async ()=>{ // ASYNC
    const username = document.getElementById('pd_name').textContent;
    if(!username || username==='â€”') return alert('Open a patient first');
    const logs = await loadLogs(); const arr = logs[username] || []; // AWAIT
    let csv = 'time,patient,event,medName,note\n';
    arr.forEach(e=>{
        csv += `"${e.ts}","${username}","${e.type}","${e.medName||''}","${(e.note||'').replace(/"/g,'""')}"\n`;
    });
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'}); const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `${username}_adherence.csv`; a.click(); a.remove();
});

/* -------------------------
    Render patient meds and events
    ------------------------- */
async function renderPatientMeds(username){ // ASYNC
    const meds = await loadMeds(); // AWAIT
    const list = meds[username] || [];
    const wrap = document.getElementById('pd_meds'); 
    if(list.length===0){ wrap.innerHTML = '<div class="muted">No medications assigned</div>'; return;}
    let html = '<table><tr><th>Med</th><th>Dosage</th><th>Schedule</th><th>Instr</th></tr>';
    list.forEach(m => { html += `<tr><td>${m.name}</td><td>${m.dosage||''}</td><td>${m.schedule||''}</td><td>${m.instructions||''}</td></tr>`; });
    html += '</table>'; wrap.innerHTML = html;
}

async function renderPatientEvents(username){ // ASYNC
    const logs = await loadLogs(); // AWAIT
    const arr = logs[username] || [];
    const wrap = document.getElementById('pd_events');
    if(arr.length===0) { wrap.innerHTML = '<div class="muted">No events</div>'; return; }
    let html = '<table><tr><th>Time</th><th>Med</th><th>Type</th><th>Note</th></tr>';
    arr.slice().reverse().forEach(e => {
        html += `<tr><td>${new Date(e.ts).toLocaleString()}</td><td>${e.medName||e.medId||'â€”'}</td><td>${e.type}</td><td>${e.note||''}</td></tr>`;
    });
    html += '</table>'; wrap.innerHTML = html;
}

/* -------------------------
    Add medication (doctor)
    ------------------------- */
document.getElementById('d_addMedBtn').addEventListener('click', async ()=>{ // ASYNC
    const patient = document.getElementById('selectPatient').value;
    const name = document.getElementById('d_medName').value.trim();
    const type = document.getElementById('d_medType').value;
    const dosage = document.getElementById('d_medDose').value.trim();
    const schedule = document.getElementById('d_medSchedule').value;
    const instr = document.getElementById('d_medInstr').value.trim();
    if(!patient){ alert('Select patient'); return; }
    if(!name){ alert('Enter medication name'); return; }
    
    const meds = await loadMeds(); // AWAIT
    if(!meds[patient]) meds[patient]=[];
    
    const entry = { id: 'med-'+uid(), name, type, dosage, schedule, instructions: instr, addedBy: 'doctor:' + current, createdAt: new Date().toISOString() };
    meds[patient].push(entry); 
    await saveMeds(meds); // AWAIT
    
    if (document.getElementById('pd_name').textContent === patient) {
        await renderPatientMeds(patient); // AWAIT
        await buildPatientCharts(patient); // AWAIT
    }
    await renderMedManagement(); // AWAIT
    await renderSummary(); // AWAIT
    alert('Medication added for ' + patient);
});

/* -------------------------
    Patient summary / med management / logs (reuse earlier functions)
    ------------------------- */
async function renderSummary(){ // ASYNC
    const users = await loadUsers(); // AWAIT
    const meds = await loadMeds(); // AWAIT

    const patients = users.filter(u=>u.role==='patient' && u.approved && u.assignedDoctor === current); 
    
    // ðŸ”‘ FIX: 
    // 1. Create a variable (patientRows) to hold the array of strings.
    // 2. AWAIT the result of Promise.all(map) to get the array.
    const patientRows = await Promise.all(patients.map(async p => {
        const pMeds = meds[p.username] || [];
        const { taken, missed } = await getPatientAdherence(p.username); // AWAIT
        
        // Ensure you await loadLogs here as well
        const evs = await loadLogs(); 
        const pLogs = evs[p.username] || [];

        const denom = taken+missed;
        const pct = denom ? Math.round((taken/denom)*100) : 'â€”';
        return `<tr><td>${p.username}</td><td>${pMeds.length}</td><td>${pLogs.length}</td><td>${pct}</td></tr>`;
    }));
    
    // 3. Now, call .join('') on the awaited array (patientRows)
    const html = '<table><tr><th>Patient</th><th>Meds</th><th>Events</th><th>Adherence % (7d est)</th></tr>' + 
                 patientRows.join('') + 
                 '</table>';
                 
    document.getElementById('patientSummary').innerHTML = html;
}
async function renderMedManagement(){ // ASYNC
    const meds = await loadMeds(); // AWAIT
    const users = await loadUsers(); // AWAIT

    const approvedPatients = users.filter(u=>u.role==='patient' && u.approved && u.assignedDoctor === current);
    const wrap = document.getElementById('medManagement');
    if(approvedPatients.length===0){ wrap.innerHTML = '<div class="muted">No approved patients assigned to you</div>'; return; }
    let html = '';
    approvedPatients.forEach(p=>{
        html += `<h4 style="margin-bottom:6px">${p.username}</h4>`;
        const list = meds[p.username] || [];
        if(list.length===0){ html += '<div class="muted">No meds</div>'; }
        else{
            html += '<table><tr><th>Med</th><th>Schedule</th><th>Instr</th><th>AddedBy</th><th>Actions</th></tr>';
            list.forEach(m=>{
                html += `<tr><td>${m.name} ${m.dosage?('â€” '+m.dosage):''}</td><td>${m.schedule}</td><td>${m.instructions||''}</td><td>${m.addedBy||''}</td><td>
                         <button onclick="editMed('${p.username}','${m.id}')">Edit</button>
                         <button onclick="deleteMedDoctor('${p.username}','${m.id}')" style="margin-left:6px" class="ghost">Delete</button>
                         </td></tr>`;
            });
            html += '</table>';
        }
    });
    wrap.innerHTML = html;
}

async function editMed(patientUser, medId){ // ASYNC
    const meds = await loadMeds(); const list = meds[patientUser] || []; const m = list.find(x=>x.id===medId); // AWAIT
    if(!m) return alert('Missing med');
    const name = prompt('Medication name', m.name); if(name===null) return;
    const dosage = prompt('Dosage', m.dosage||''); if(dosage===null) return;
    const schedule = prompt('Schedule (am/pm/both/custom)', m.schedule||''); if(schedule===null) return;
    const instr = prompt('Instructions', m.instructions||''); if(instr===null) return;
    m.name = name; m.dosage = dosage; m.schedule = schedule; m.instructions = instr;
    await saveMeds(meds); // AWAIT
    await renderMedManagement(); await renderSummary(); // AWAIT
    if (document.getElementById('pd_name').textContent === patientUser) {
        await renderPatientMeds(patientUser); // AWAIT
        await buildPatientCharts(patientUser); // AWAIT
    }
}

async function deleteMedDoctor(patientUser, medId){ // ASYNC
    if(!confirm('Delete medication?')) return;
    const meds = await loadMeds(); // AWAIT
    meds[patientUser] = (meds[patientUser]||[]).filter(m=>m.id!==medId); 
    await saveMeds(meds); // AWAIT
    await renderMedManagement(); await renderSummary(); // AWAIT
    if (document.getElementById('pd_name').textContent === patientUser) {
        await renderPatientMeds(patientUser); // AWAIT
        await buildPatientCharts(patientUser); // AWAIT
    }
}

/* -------------------------
    Logs rendering (global)
    ------------------------- */
async function renderLogs(){ // ASYNC
    const logs = await loadLogs(); // AWAIT
    const users = await loadUsers(); // AWAIT
    
    const assignedPatients = users.filter(u => u.role === 'patient' && u.approved && u.assignedDoctor === current).map(u => u.username);
    const wrap = document.getElementById('logs');
    
    if(assignedPatients.length === 0){ wrap.innerHTML = '<div class="muted">No logs from your assigned patients yet</div>'; return; }
    
    let allEvents = [];

    assignedPatients.forEach(k => {
        const arr = logs[k] || [];
        allEvents.push(...arr.map(e => ({ ...e, patient: k })));
    });
    
    if (allEvents.length === 0) {
        wrap.innerHTML = '<div class="muted">No events from your assigned patients yet</div>';
        return;
    }

    allEvents.sort((a, b) => new Date(b.ts) - new Date(a.ts));
    
    let html = '<table><tr><th>Time</th><th>Patient</th><th>Med</th><th>Type</th><th>Note</th></tr>';
    allEvents.forEach(e => {
        html += `<tr><td>${new Date(e.ts).toLocaleString()}</td><td>${e.patient}</td><td>${e.medName||e.medId}</td><td>${e.type}</td><td>${e.note||''}</td></tr>`;
    });
    html += '</table>';
    wrap.innerHTML = html;
}

/* -------------------------
    Resizable Panel Logic
    ------------------------- */
function setupResizablePatientPanel() {
    // Logic remains synchronous as it only handles DOM interaction, not data loading.
    const grid = document.querySelector('.pd-grid');
    const splitter = document.getElementById('pd-splitter');
    let isDragging = false;

    if (!grid || !splitter) return;

    // 1. Mouse Down (Start Drag)
    splitter.addEventListener('mousedown', (e) => {
        isDragging = true;
        document.body.style.cursor = 'col-resize';
        grid.style.pointerEvents = 'none'; 
        e.preventDefault(); 
    });

    // 2. Mouse Move (Dragging)
    document.addEventListener('mousemove', async (e) => { // ASYNC needed here for chart redraw
        if (!isDragging) return;

        const gridRect = grid.getBoundingClientRect();
        let newCol1Width = (e.clientX - gridRect.left) / gridRect.width * 100;

        // Set limits (min 20% / max 80%)
        newCol1Width = Math.max(20, Math.min(80, newCol1Width));
        
        const newCol2Width = 100 - newCol1Width;

        // Apply new widths using CSS variables
        grid.style.setProperty('--pd-col-1-width', `${newCol1Width}%`);
        grid.style.setProperty('--pd-col-2-width', `${newCol2Width}%`);
        
        // Crucial for Chart.js to redraw
        const openPatient = document.getElementById('pd_name').textContent;
        if (openPatient && openPatient !== 'â€”') {
            await buildPatientCharts(openPatient); // AWAIT
        }
    });

    // 3. Mouse Up (End Drag)
    document.addEventListener('mouseup', () => {
        if (isDragging) {
            isDragging = false;
            document.body.style.cursor = 'default';
            grid.style.pointerEvents = 'auto';
        }
    });
}


/* -------------------------
    Initialization / Event Handlers
    ------------------------- */
async function refreshUI(){ // ASYNC
    await computeOverall();
    await renderPending();
    await populatePatientSelector();
    await fillDoctorPatientSelect();
    await populateChatPatientSelector();
    await renderSummary();
    await renderMedManagement();
    await renderLogs();
    setupResizablePatientPanel();
    // start unread badge polling
    startUnreadPolling();
}

document.getElementById('refresh').addEventListener('click', refreshUI);

document.getElementById('logout').addEventListener('click', async ()=>{ // ASYNC
    await window.Storage.removeItem('currentUser'); // AWAIT
    await window.Storage.removeItem('currentRole'); // AWAIT
    window.location.href='doctor-login.html';
});

// Tab switching for Overview / Chat
document.getElementById('docTabOverview').addEventListener('click', ()=>{
    document.querySelectorAll('.wrap > .card').forEach(c => c.classList.remove('hidden'));
    document.getElementById('docTabOverview').classList.add('ghost');
    document.getElementById('docTabChat').classList.remove('ghost');
    stopDoctorChatPolling();
});
document.getElementById('docTabChat').addEventListener('click', ()=>{
    document.querySelectorAll('.wrap > .card').forEach(c => c.classList.add('hidden'));
    const chatCard = document.getElementById('doctorChatCard'); if(chatCard) chatCard.classList.remove('hidden');
    document.getElementById('docTabChat').classList.add('ghost');
    document.getElementById('docTabOverview').classList.remove('ghost');
});

// Chat UI event wiring
document.getElementById('openChat').addEventListener('click', async ()=>{
    try{
        const sel = document.getElementById('chatPatientSelector'); if(!sel) return; const patient = sel.value; if(!patient) return alert('Select a patient');
        document.getElementById('doctorChat').classList.remove('hidden');
        await renderDoctorChat(patient);
        await setLastSeenForPatient(patient);
        await updateUnreadBadge();
        startDoctorChatPolling(patient);
    }catch(err){ console.error('Open chat error', err); alert('Failed to open chat (see console)'); }
});
document.getElementById('doctorChatSend').addEventListener('click', async ()=>{
    try{
        const sel = document.getElementById('chatPatientSelector'); if(!sel) return; const patient = sel.value; if(!patient) return alert('Select a patient');
        const input = document.getElementById('doctorChatInput'); if(!input) return; const txt = input.value; input.value=''; await sendDoctorChat(patient, txt);
    }catch(err){ console.error('Send chat error', err); alert('Failed to send message (see console)'); }
});
document.getElementById('doctorChatInput').addEventListener('keydown', async (e)=>{ if(e.key==='Enter'){ e.preventDefault(); document.getElementById('doctorChatSend').click(); } });
document.getElementById('clearChatDoc').addEventListener('click', async ()=>{
    const sel = document.getElementById('chatPatientSelector'); if(!sel) return; const patient = sel.value; if(!patient) return alert('Select a patient');
    if(confirm('Clear chat history for ' + patient + '?')){ await clearDoctorChat(patient); }
});

// Final initialization call (Starts the entire process)
document.addEventListener("DOMContentLoaded", checkAuthAndInit);
</script>

<script>
    // Moved the auto-select logic into a new function to ensure it runs after 
    // the main initialization. This is a robust way to ensure the elements are ready.
    async function postInitAutoDisplay() {
        // Wait for the full UI refresh to complete
        await new Promise(resolve => setTimeout(resolve, 100)); // Small delay for rendering

        // ----------------------------------------------------
        // Auto-select and open patient1 for demonstration
        // ----------------------------------------------------
        const selector = document.getElementById('patientSelector');
        if (selector) {
            selector.value = 'patient1';
        }
        
        // This function must be awaited since it loads and displays data
        await openPatientPanel('patient1');
        
        console.log("Auto-display of patient1 completed.");
    }

    // Replace the final block from the previous response with this structure:
    document.addEventListener("DOMContentLoaded", async () => {
            await checkAuthAndInit(); // This runs seedDemo() and refreshUI()
            if (current && role === 'doctor') {
                await postInitAutoDisplay();
            }
        });
    </script>
            <footer class="site-footer">
                <div class="container" style="max-width:1200px;display:grid;grid-template-columns:repeat(4,1fr);gap:24px;">
                    <div>
                        <h3 style="color:#7dd3fc;font-size:1.25rem;margin-bottom:8px;">TYM</h3>
                        <p style="color:#9ca3af;font-size:0.9rem;">Empowering better health through innovative medication adherence solutions.</p>
                    </div>
                    <div>
                        <h4 style="font-weight:600;margin-bottom:8px;">Quick Links</h4>
                        <ul style="list-style:none;padding:0;margin:0;color:#93c5fd;">
                            <li><a href="merged.html#home">Home</a></li>
                            <li><a href="merged.html#about">About</a></li>
                            <li><a href="merged.html#solutions">Solutions</a></li>
                            <li><a href="merged.html#contact">Contact</a></li>
                        </ul>
                    </div>
                    <div>
                        <h4 style="font-weight:600;margin-bottom:8px;">Resources</h4>
                        <ul style="list-style:none;padding:0;margin:0;color:#93c5fd;">
                            <li><a href="#">Blog</a></li>
                            <li><a href="#">Research</a></li>
                            <li><a href="#">FAQ</a></li>
                            <li><a href="#">Support</a></li>
                        </ul>
                    </div>
                    <div>
                        <h4 style="font-weight:600;margin-bottom:8px;">Contact Us</h4>
                        <ul style="list-style:none;padding:0;margin:0;color:#93c5fd;">
                            <li>âœ‰ï¸ info@tym.health</li>
                            <li>ðŸ“ž (555) 123-4567</li>
                            <li>ðŸ“ San Francisco, CA</li>
                        </ul>
                    </div>
                </div>
                <div style="text-align:center;margin-top:24px;color:#94a3b8;">Â© 2026 Take Your Medicine Innovations. All rights reserved.</div>
            </footer>
    </body>
    </html>